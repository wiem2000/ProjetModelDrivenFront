@{
    ViewData["Title"] = "Générateur de Solution Power Apps";
}

<div style="margin-top:5cm">






<div class="row">

    <div class="col">

<h2>🧠 Générateur PowerApps depuis JSON</h2>

<form id="solutionForm">
    <textarea id="jsonInput" rows="20" cols="100" placeholder="Collez ici votre JSON..."></textarea>
    <br />
    <button type="submit">🚀 Générer</button>
</form>

<div id="result"></div>
    
</div>

    <div class="col">

        <h2>Suivi en temps réel</h2>
        <ul id="logs"></ul>

    </div>

</div>

</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>

    <script>
        document.getElementById("solutionForm").addEventListener("submit", async function (e) {
            e.preventDefault();

            const json = document.getElementById("jsonInput").value;

            try {
                const response = await fetch("https://localhost:7094/api/PowerApps/build-solution", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: json
                });

                        const data = await response.json();

        if (data.details && data.details.appUrl) {
            document.getElementById("result").innerHTML =
                `<p>✅ Solution générée avec succès ! <a href="${data.details.appUrl}" target="_blank">👉 Cliquez ici pour accéder à l'application</a></p>`;
        } else {
            document.getElementById("result").innerHTML =
                `<p>✅ Solution générée mais aucun lien d'application trouvé dans la réponse.</p>`;
        }

            } catch (err) {
                document.getElementById("result").innerHTML =
                    `<span style="color:red">❌ Erreur : ${err}</span>`;
            }
        });
    </script>

    <!-- SignalR côté client -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>

    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("https://localhost:7094/loghub") // 🔁 Remplace par le bon port de ton projet API
            .configureLogging(signalR.LogLevel.Information)
            .build();

        connection.start()
            .then(() => {
                console.log("✅ Connexion réussie !");
                document.getElementById("logs").innerHTML += "<li>✅ Connexion réussie !</li>";
            })
            .catch(err => {
                console.error("❌ Échec de connexion :", err);
                document.getElementById("logs").innerHTML += "<li style='color:red'>❌ Connexion échouée</li>";
            });

        connection.on("ReceiveLog", (message) => {
            document.getElementById("logs").innerHTML += `<li>${message}</li>`;
        });
    </script>
}